<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>nginx设置资源缓存实战 | 车程一的博客</title>
    <meta name="description" content="车程一的博客">
    <link rel="icon" href="/vue-logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.2fbf6f8b.css" as="style"><link rel="preload" href="/assets/js/app.7b18d2f0.js" as="script"><link rel="preload" href="/assets/js/16.659d2a43.js" as="script"><link rel="prefetch" href="/assets/js/10.ea08bc69.js"><link rel="prefetch" href="/assets/js/11.59d62fd9.js"><link rel="prefetch" href="/assets/js/12.426af9d7.js"><link rel="prefetch" href="/assets/js/13.b2bd6144.js"><link rel="prefetch" href="/assets/js/14.1790ff5e.js"><link rel="prefetch" href="/assets/js/15.584f93ea.js"><link rel="prefetch" href="/assets/js/17.7825b058.js"><link rel="prefetch" href="/assets/js/18.0b08fef9.js"><link rel="prefetch" href="/assets/js/19.c553a9ae.js"><link rel="prefetch" href="/assets/js/2.ef1579f9.js"><link rel="prefetch" href="/assets/js/20.1a95086a.js"><link rel="prefetch" href="/assets/js/21.57c66887.js"><link rel="prefetch" href="/assets/js/22.3570ca0d.js"><link rel="prefetch" href="/assets/js/23.7fe8ebe9.js"><link rel="prefetch" href="/assets/js/24.5c706192.js"><link rel="prefetch" href="/assets/js/25.d8757158.js"><link rel="prefetch" href="/assets/js/26.8399a71b.js"><link rel="prefetch" href="/assets/js/27.4b3a213a.js"><link rel="prefetch" href="/assets/js/28.eb31cdf1.js"><link rel="prefetch" href="/assets/js/29.577144a6.js"><link rel="prefetch" href="/assets/js/3.62eea2c7.js"><link rel="prefetch" href="/assets/js/30.ef956d23.js"><link rel="prefetch" href="/assets/js/31.2e8ab40d.js"><link rel="prefetch" href="/assets/js/32.9d1685a0.js"><link rel="prefetch" href="/assets/js/33.d800be4d.js"><link rel="prefetch" href="/assets/js/34.85d350fe.js"><link rel="prefetch" href="/assets/js/35.1625e166.js"><link rel="prefetch" href="/assets/js/36.5cf7699d.js"><link rel="prefetch" href="/assets/js/37.0437fe8d.js"><link rel="prefetch" href="/assets/js/38.ca058290.js"><link rel="prefetch" href="/assets/js/39.d4f95e20.js"><link rel="prefetch" href="/assets/js/4.91c625b2.js"><link rel="prefetch" href="/assets/js/40.211acfac.js"><link rel="prefetch" href="/assets/js/41.a5df0168.js"><link rel="prefetch" href="/assets/js/42.6318b490.js"><link rel="prefetch" href="/assets/js/43.a6543bac.js"><link rel="prefetch" href="/assets/js/44.b04565e5.js"><link rel="prefetch" href="/assets/js/45.3bb1a5c1.js"><link rel="prefetch" href="/assets/js/46.15ed4362.js"><link rel="prefetch" href="/assets/js/47.e838dcd2.js"><link rel="prefetch" href="/assets/js/48.0a220d6c.js"><link rel="prefetch" href="/assets/js/49.a81b7774.js"><link rel="prefetch" href="/assets/js/5.a6bc510c.js"><link rel="prefetch" href="/assets/js/50.5ae2a1df.js"><link rel="prefetch" href="/assets/js/51.1e50c0a5.js"><link rel="prefetch" href="/assets/js/52.05832c5b.js"><link rel="prefetch" href="/assets/js/6.edf1ab01.js"><link rel="prefetch" href="/assets/js/7.75a4d63f.js"><link rel="prefetch" href="/assets/js/8.ac427bc7.js"><link rel="prefetch" href="/assets/js/9.7c5ccd0b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2fbf6f8b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">车程一的博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div> <a href="https://github.com/chechengyi" target="_blank" rel="noopener noreferrer" class="repo-link">
    我的github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div> <a href="https://github.com/chechengyi" target="_blank" rel="noopener noreferrer" class="repo-link">
    我的github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading open"><span>前端实战</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/blog/前端实战/跨域及其处理方式.html" class="sidebar-link">跨域及其处理方式</a></li><li><a href="/blog/前端实战/移动端适配问题.html" class="sidebar-link">移动端适配问题</a></li><li><a href="/blog/前端实战/给localStorage加上过期时间.html" class="sidebar-link">给localStorage加上过期时间</a></li><li><a href="/blog/前端实战/react实现一个分页、搜索高阶组件.html" class="sidebar-link">react实现一个分页、搜索高阶组件</a></li><li><a href="/blog/前端实战/nginx设置资源缓存实战.html" class="active sidebar-link">nginx设置资源缓存实战</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/前端实战/nginx设置资源缓存实战.html#初探" class="sidebar-link">初探</a></li><li class="sidebar-sub-header"><a href="/blog/前端实战/nginx设置资源缓存实战.html#nginx禁用强缓存" class="sidebar-link">nginx禁用强缓存</a></li><li class="sidebar-sub-header"><a href="/blog/前端实战/nginx设置资源缓存实战.html#结语" class="sidebar-link">结语</a></li><li class="sidebar-sub-header"><a href="/blog/前端实战/nginx设置资源缓存实战.html#扩展" class="sidebar-link">扩展</a></li></ul></li><li><a href="/blog/前端实战/前后端分离下前端权限处理.html" class="sidebar-link">前后端分离下前端权限处理</a></li><li><a href="/blog/前端实战/从react hooks“闭包陷阱”切入，浅谈react hooks.html" class="sidebar-link">从react hooks“闭包陷阱”切入，浅谈react hooks</a></li><li><a href="/blog/前端实战/BFC及其理解.html" class="sidebar-link">BFC及其理解</a></li><li><a href="/blog/前端实战/react优化-精确更新视窗内组件.html" class="sidebar-link">react优化-精确更新视窗内组件</a></li><li><a href="/blog/前端实战/typescript内置类型学习.html" class="sidebar-link">typescript内置类型学习</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>js相关</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>react理解</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>总结记录</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>数据结构算法</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="nginx设置资源缓存实战"><a href="#nginx设置资源缓存实战" aria-hidden="true" class="header-anchor">#</a> nginx设置资源缓存实战</h1> <p>关于缓存讲解的文章推荐一篇来自掘金的文章：<a href="https://juejin.im/post/5eb7f811f265da7bbc7cc5bd" target="_blank" rel="noopener noreferrer">https://juejin.im/post/5eb7f811f265da7bbc7cc5bd<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>一直很想学习缓存这一块儿的东西，毕竟前端性能优化缓存在其中占了很大一部分作用。缓存分为两种：强制缓存和协商缓存。看过很多文章讲它们之间的区别，但是没有实战过只知道其意义却不知道怎样去设置，没有实战过也导致记忆总是很模糊，实践才是最好的老师！记录一下我使用nginx服务器学习缓存的过程。</p> <h2 id="初探"><a href="#初探" aria-hidden="true" class="header-anchor">#</a> 初探</h2> <p>首先我在 <em>nginx</em> 的根目录下新建了一个 <code>index.html</code> 文件以及 <code>index.js</code> 文件。此时 <code>nginx</code>  的配置文件是长这个样子的：</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">listen</span>       <span class="token number">8080</span><span class="token punctuation">;</span>
  <span class="token keyword">server_name</span>  localhost<span class="token punctuation">;</span>
  <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
     <span class="token keyword">root</span>  <span class="token operator">/</span>Volumes<span class="token operator">/</span>myFile<span class="token operator">/</span>nginx_root<span class="token punctuation">;</span>   
     <span class="token keyword">index</span>  <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后我们浏览器访问 localhost:8080。打开控制台，发现里面有两条请求：</p> <p><img src="https://user-gold-cdn.xitu.io/2019/10/26/16e075f3bcd72de4?w=1017&h=85&f=png&s=20843" alt></p> <p>可以看到第一次访问，两条请求的状态码都是 200。我们点开其中一条请求看看响应头信息：</p> <p><img src="https://user-gold-cdn.xitu.io/2019/10/26/16e075f3bdc4481b?w=633&h=199&f=png&s=37363" alt></p> <p>可以看到，响应头中给我们携带了 <code>Etag</code> 以及 <code>Last-Modified</code> 信息。这就是协商缓存所使用的字段嘛。看来 <em>nginx</em> 已经默认给我们使用了缓存。那我们在不修改 html文件以及js文件的基础上再次去刷新页面验证一下，命中协商缓存的话，状态码应该给我们返回 <code>304 Not Modified</code> 。我刷新了几次去观察http请求的状态码。html文件每次都是返回的 304。但是 js 文件在最初是 304 后面却变成了 <code>200 OK (from memory cache)</code> 。也就是说每一次html文件都是命中了协商缓存，而js文件都是命中了强缓存(强缓存的优先级是高于协商缓存的)。为什么会出现这样的情况呢，我百度一下：</p> <blockquote><p>为什么有的缓存是 200 OK (from cache)，有的缓存是 304 Not Modified 呢？很简单，看是否移除了 Entity Tag。移除了，就总是 200 OK (from cache)。没有移除，就两者会交替出现。</p> <p>那么，两者触发的时机有什么区别呢？200 OK (from cache) 是直接点击链接访问，输入网址按回车访问也能触发；而 304 Not Modified 是刷新页面时触发，或是设置了强缓存、但 Entity Tags 没有移除时触发。</p></blockquote> <p>对照我的例子，我是这样理解的：<code>index.html</code> 文件刷新页面命中协商缓存返回了 304，而 js 文件是在 index.html 文件中链接引入的，所以命中强缓存 200 OK (from cache) 。为了验证我的想法，我用在地址栏直接访问了 <code>index.js</code> 文件。地址栏键入：localhost:8080/index.js，此时的确是返回了 304 给我了，在来看一下此时的请求头：</p> <p><img src="https://user-gold-cdn.xitu.io/2019/10/26/16e075f3beded97b?w=769&h=294&f=png&s=78103" alt></p> <p>可以看到此时 <code>Cache-Control</code> 给的是max-age=0；然后也携带上了协商缓存的相关参数。看来在浏览器是刷新操作的时候就会携带上 <code>Cache-Control:max-age=0</code> 以此来避免命中强缓存。</p> <h2 id="nginx禁用强缓存"><a href="#nginx禁用强缓存" aria-hidden="true" class="header-anchor">#</a> nginx禁用强缓存</h2> <p>在试试 <em>nginx</em> 禁用强缓存之后会发生什么效果。修改 <em>nginx</em> 配置文件：</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">listen</span>       <span class="token number">8080</span><span class="token punctuation">;</span>
  <span class="token keyword">server_name</span>  localhost<span class="token punctuation">;</span>
  <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
     <span class="token keyword">root</span>  <span class="token operator">/</span>Volumes<span class="token operator">/</span>myFile<span class="token operator">/</span>nginx_root<span class="token punctuation">;</span>   
     <span class="token keyword">index</span>  <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
     <span class="token keyword">add_header</span> Cache<span class="token operator">-</span>Control no<span class="token operator">-</span>cache<span class="token punctuation">;</span>
     <span class="token comment"># 为 public可以被任何对象缓存，private只能针对个人用户，而不能被代理服务器缓存</span>
     <span class="token keyword">add_header</span> Cache<span class="token operator">-</span>Control private<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>修改完 <em>nginx</em> 配置文件之后我们重启一下 <em>nginx</em> 服务器。此时在访问 localhost:8080</p> <p><img src="https://user-gold-cdn.xitu.io/2019/10/26/16e075f3be74f974?w=969&h=250&f=png&s=54580" alt></p> <p>可以看到，此时 html 文件和 js文件都是 304 都是命中协商缓存了。</p> <blockquote><p><strong>Cache-Control</strong>：<strong>no-store</strong></p> <p>禁止一切缓存（这个才是响应不被缓存的意思）。缓存通常会像非缓存代理服务器一样，向客户端转发一条 no-store 响应，然后删除对象。</p> <p><strong>Cache-Control：no-cache</strong></p> <p>强制客户端直接向服务器发送请求,也就是说每次请求都必须向服务器发送。服务器接收到请求，然后判断资源是否变更，是则返回新内容，否则返回304，未变更。这个很容易让人产生误解，使人误以为是响应不被缓存。实际上Cache-Control: no-cache是会被缓存的，只不过每次在向客户端（浏览器）提供响应数据时，缓存都要向服务器评估缓存响应的有效性。</p></blockquote> <p>其实将 <strong>Cache-Control</strong> 设置为 <strong>no-store</strong> 才是真正的不被缓存的意思，那在修改一下 <em>nginx</em> 文件将 <strong>Cache-Control</strong> 设置为 <strong>no-store</strong> 看看会发生什么。此时再次刷新浏览器。</p> <p><img src="https://user-gold-cdn.xitu.io/2019/10/26/16e075f3bfedd272?w=1024&h=253&f=png&s=56460" alt></p> <p>可以看到，修改完 <em>nginx</em> 的配置文件之后，除了第一次是304(这次访问浏览器才刚刚接收到 no-store的信息，请求头上还是携带了缓存相关信息) 外，剩下的几次刷新页面都是返回 200了。既没有命中强缓存、也没有命中协商缓存。在看一下 <code>index.js</code> 文件的 http 头信息。</p> <p><img src="https://user-gold-cdn.xitu.io/2019/10/26/16e075f3bf81d64a?w=1166&h=350&f=png&s=114228" alt></p> <p>这里的图我没有截完整，其实响应头中还包含了<strong>Cache-Control: no-store</strong>。可以看到，在<strong>Cache-Control: no-store</strong> 的加持下，即使在响应头中服务请返回了协商缓存的参数，但是在浏览器在请求资源的时候，并没有带上缓存相关的参数了，所以，现在没有缓存了，既不会命中强缓存，也不会命中协商缓存，每一次http请求的资源都是从服务器上返回的。</p> <h2 id="结语"><a href="#结语" aria-hidden="true" class="header-anchor">#</a> 结语</h2> <p>这次的探索到现在就结束了，其实就是我一次学习的记录吧。实践了一次之后确实对缓存有了更清晰的理解和认知，果真实践出真知。后续打算还会记录一篇在现在前端使用 React.js 或者 Vue.js 等框架打包之后前端资源如何利用 <em>nginx</em> 做部署还有配置相关缓存的文章，到时候在看有没有记录下来的意义把。</p> <h2 id="扩展"><a href="#扩展" aria-hidden="true" class="header-anchor">#</a> 扩展</h2> <p>平时我们在谈论 <code>nginx</code> 的时候，总是会说到 <code>nginx</code> <strong>反向代理</strong>，那就会自然而然的产生一个疑问， 有没有正向代理呢？它与反向代理的区别是什么？</p> <p>比如说，我现在想要使用谷歌搜索引擎，但是由于在国内的原因，直接访问是访问不到的。这时候我们就可以通过一个代理服务器，请求发送到代理服务器，代理服务器再去访问谷歌取到数据在返回给我们，这样就能访问到谷歌了。
<img src="https://s1.ax1x.com/2020/10/30/BtR8c4.png" alt="正向代理"></p> <p>在看反向代理，反向代理实际运行方式是指以代理服务器来接受internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给internet上请求连接的客户端，此时代理服务器对外就表现为一个服务器。
<img src="https://s1.ax1x.com/2020/10/30/BtW3IP.png" alt="反向代理">
反向代理的作用：</p> <ol><li>保证内网的安全，阻止web攻击，大型网站，通常将反向代理作为公网访问地址，Web服务器是内网</li> <li>负载均衡，通过反向代理服务器来优化网站的负载</li></ol> <p>总结一下，正向代理即是客户端代理， 代理客户端, 服务端不知道实际发起请求的客户端。反向代理即是服务端代理，代理服务端, 客户端不知道实际提供服务的服务端。 借用在其他文章中看到的总结的特别好的一句话：正向代理是找黄牛买票，反向代理是租房的中介。</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.7b18d2f0.js" defer></script><script src="/assets/js/16.659d2a43.js" defer></script>
  </body>
</html>
