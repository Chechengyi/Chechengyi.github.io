<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>给localStorage加上过期时间 | 车程一的博客</title>
    <meta name="description" content="车程一的博客">
    <link rel="icon" href="/vue-logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.2fbf6f8b.css" as="style"><link rel="preload" href="/assets/js/app.7b18d2f0.js" as="script"><link rel="preload" href="/assets/js/26.8399a71b.js" as="script"><link rel="prefetch" href="/assets/js/10.ea08bc69.js"><link rel="prefetch" href="/assets/js/11.59d62fd9.js"><link rel="prefetch" href="/assets/js/12.426af9d7.js"><link rel="prefetch" href="/assets/js/13.b2bd6144.js"><link rel="prefetch" href="/assets/js/14.1790ff5e.js"><link rel="prefetch" href="/assets/js/15.584f93ea.js"><link rel="prefetch" href="/assets/js/16.659d2a43.js"><link rel="prefetch" href="/assets/js/17.7825b058.js"><link rel="prefetch" href="/assets/js/18.0b08fef9.js"><link rel="prefetch" href="/assets/js/19.c553a9ae.js"><link rel="prefetch" href="/assets/js/2.ef1579f9.js"><link rel="prefetch" href="/assets/js/20.1a95086a.js"><link rel="prefetch" href="/assets/js/21.57c66887.js"><link rel="prefetch" href="/assets/js/22.3570ca0d.js"><link rel="prefetch" href="/assets/js/23.7fe8ebe9.js"><link rel="prefetch" href="/assets/js/24.5c706192.js"><link rel="prefetch" href="/assets/js/25.d8757158.js"><link rel="prefetch" href="/assets/js/27.4b3a213a.js"><link rel="prefetch" href="/assets/js/28.eb31cdf1.js"><link rel="prefetch" href="/assets/js/29.577144a6.js"><link rel="prefetch" href="/assets/js/3.62eea2c7.js"><link rel="prefetch" href="/assets/js/30.ef956d23.js"><link rel="prefetch" href="/assets/js/31.2e8ab40d.js"><link rel="prefetch" href="/assets/js/32.9d1685a0.js"><link rel="prefetch" href="/assets/js/33.d800be4d.js"><link rel="prefetch" href="/assets/js/34.85d350fe.js"><link rel="prefetch" href="/assets/js/35.1625e166.js"><link rel="prefetch" href="/assets/js/36.5cf7699d.js"><link rel="prefetch" href="/assets/js/37.0437fe8d.js"><link rel="prefetch" href="/assets/js/38.ca058290.js"><link rel="prefetch" href="/assets/js/39.d4f95e20.js"><link rel="prefetch" href="/assets/js/4.91c625b2.js"><link rel="prefetch" href="/assets/js/40.211acfac.js"><link rel="prefetch" href="/assets/js/41.a5df0168.js"><link rel="prefetch" href="/assets/js/42.6318b490.js"><link rel="prefetch" href="/assets/js/43.a6543bac.js"><link rel="prefetch" href="/assets/js/44.b04565e5.js"><link rel="prefetch" href="/assets/js/45.3bb1a5c1.js"><link rel="prefetch" href="/assets/js/46.15ed4362.js"><link rel="prefetch" href="/assets/js/47.e838dcd2.js"><link rel="prefetch" href="/assets/js/48.0a220d6c.js"><link rel="prefetch" href="/assets/js/49.a81b7774.js"><link rel="prefetch" href="/assets/js/5.a6bc510c.js"><link rel="prefetch" href="/assets/js/50.5ae2a1df.js"><link rel="prefetch" href="/assets/js/51.1e50c0a5.js"><link rel="prefetch" href="/assets/js/52.05832c5b.js"><link rel="prefetch" href="/assets/js/6.edf1ab01.js"><link rel="prefetch" href="/assets/js/7.75a4d63f.js"><link rel="prefetch" href="/assets/js/8.ac427bc7.js"><link rel="prefetch" href="/assets/js/9.7c5ccd0b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2fbf6f8b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">车程一的博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div> <a href="https://github.com/chechengyi" target="_blank" rel="noopener noreferrer" class="repo-link">
    我的github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div> <a href="https://github.com/chechengyi" target="_blank" rel="noopener noreferrer" class="repo-link">
    我的github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading open"><span>前端实战</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/blog/前端实战/跨域及其处理方式.html" class="sidebar-link">跨域及其处理方式</a></li><li><a href="/blog/前端实战/移动端适配问题.html" class="sidebar-link">移动端适配问题</a></li><li><a href="/blog/前端实战/给localStorage加上过期时间.html" class="active sidebar-link">给localStorage加上过期时间</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/前端实战/react实现一个分页、搜索高阶组件.html" class="sidebar-link">react实现一个分页、搜索高阶组件</a></li><li><a href="/blog/前端实战/nginx设置资源缓存实战.html" class="sidebar-link">nginx设置资源缓存实战</a></li><li><a href="/blog/前端实战/前后端分离下前端权限处理.html" class="sidebar-link">前后端分离下前端权限处理</a></li><li><a href="/blog/前端实战/从react hooks“闭包陷阱”切入，浅谈react hooks.html" class="sidebar-link">从react hooks“闭包陷阱”切入，浅谈react hooks</a></li><li><a href="/blog/前端实战/BFC及其理解.html" class="sidebar-link">BFC及其理解</a></li><li><a href="/blog/前端实战/react优化-精确更新视窗内组件.html" class="sidebar-link">react优化-精确更新视窗内组件</a></li><li><a href="/blog/前端实战/typescript内置类型学习.html" class="sidebar-link">typescript内置类型学习</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>js相关</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>react理解</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>总结记录</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>数据结构算法</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="给localstorage加上过期时间"><a href="#给localstorage加上过期时间" aria-hidden="true" class="header-anchor">#</a> 给localStorage加上过期时间</h1> <h3 id="一、酷酷的开头"><a href="#一、酷酷的开头" aria-hidden="true" class="header-anchor">#</a> 一、酷酷的开头</h3> <p>在掘金潜水的时间长达一年之后，我终于鼓起勇气开始写我的第一篇文章了。前端小菜，只是想记录一下自己的想法，望各位看到这文的大佬轻喷。</p> <p>在现在前后端分离的开发模式下，存储信息一般都不在使用以往使用的cookie了，就拿笔主我之前做过的项目来说。我们都是登录成功了之后后端会返回给我一个token，一般情况下我会将这个token存到<code>localStorage</code>中，后续再每一次请求中都会将这个token携带在请求头中。 至于为什么要存到<code>localStorage</code>中呢，相信做过单页web应用的开发者们也知道，如果不存着，那用户刷新了就啥都没有了。</p> <p>可以见得前端存储在项目中是越来越重要了，浏览器给我们提供了两个存储方案，一个是<code>localStorage</code>，一个是<code>sessionStorage</code>。 存到<code>localStorage</code>中的信息是永久存储,如果用户不手动删除或者代码中没有<code>localStorage.removeItem(xxx)</code>这样的调用那这个信息将永远不会消失; 在<code>sessionStorage</code>中存储的信息则是一次性的，用户关掉网页了下一次在进入这个网页信息就不会再存储了。 但是在实际项目的运用中，这两个方案的表现都不是那么令人满意。就比如说，我想要实现用户登录之后七天之内不需要再次登录这样的功能，token生成了之后，后端设置了这个token的过期时间为7天，ok，传到前端， 但是针对浏览器目前提供的存储方案，我却只能选择永久存储和一次性存储。一次性存储肯定是不能满足需求的，永久存储也违背了我的意愿。</p> <h3 id="二、之前在项目中的解决方案"><a href="#二、之前在项目中的解决方案" aria-hidden="true" class="header-anchor">#</a> 二、之前在项目中的解决方案</h3> <p>之前我在项目中的做法是，在用<code>localStorage</code>存储了token值的同时， 我还存了一个过期时间（一个毫秒数），然后在项目初始化的时候我就会去检查这个时间看看是不是已经小于当前时间了，如果是就将token删掉。 这样后续项目在使用到这个token的时候token就已经从<code>localStorage</code>中被删掉了。但是这样做也有一个问题，如果打开项目的时间刚好是还有10s token就过期的话，token也不会被删掉了。于是我脑袋里就在构想一个可（垃）靠（圾）的解决方案，一不做，二不休，我把它封装成了一个工具。</p> <p>先厚脸皮的介绍一下我的项目， <strong>sweet-storage</strong>,  请无视这土的要死的名字。
github的地址为：<a href="https://github.com/Chechengyi/sweet-storage" target="_blank" rel="noopener noreferrer">https://github.com/Chechengyi/sweet-storage<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。 顺便也正（卑）大（鄙）光（无）明（耻）的求一波star。
<img src="https://user-gold-cdn.xitu.io/2019/4/17/16a2b15609f36072?w=640&h=640&f=jpeg&s=22824" alt></p> <h3 id="三、提出新的想法"><a href="#三、提出新的想法" aria-hidden="true" class="header-anchor">#</a> 三、提出新的想法</h3> <p>咳咳咳！ 废话不多说了，讲一下我的实现思路。</p> <p>在遇到有过期时间的存储需求时， 用我这个项目举栗子， <code>storage.save('name', 'chechengyi', 10000)</code>  这行代码的意思是我想在<code>localStorage</code>中存一个键为name，值为chechengyi的信息，我希望这条信息只存10s，在将信息存入localStorage中的同时，我会把它的过期时间信息以</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token punctuation">{</span>
      key<span class="token punctuation">:</span> time
  <span class="token punctuation">}</span>
</code></pre></div><p>的形式也存到localStorage中。 key就是键， time就是这条信息到期的时间。 这里的时间的话应该存的是<code>new Date().getTime()</code>+我们设置的时间。这样就得到了一个精确的毫秒数了。  这个过期时间信息在我的项目中以<code>ISTORAGE_RECORD</code>的字段存储。 然后后面我们在根据这里面所提取出来的时间，即：<code>new Date().getTime()-time</code>这个时间去做一个定时器。定时器时间到了就将<code>localStorage</code>中存的信息以及存的时间信息就是那个对象中的key-time删掉就行了。</p> <p>但是这里也有一个问题，就是。可能我们需要有过期时间存储的时间不只有一条啊。难道存了三条我就做三个定时器？存的100条我就做100个定时器？ 这也太low了而且也并不符合实际。于是我冥思苦想，发现我前几天刚学习的优先队列很适合用在这里。</p> <p>我们可以这样做，基于<code>ISTORAGE_RECORD</code>拿出来的对象里的time去做一个最小堆（我的这个优先队列是基于最小堆的），最小堆嘛，根节点肯定就是最小的，time最小的那个不就是最先执行的定时器吗？  等这个定时器执行时就删掉<code>localStorage</code>里存的信息和时间信息，然后优先队列出列，下一个排队等着出列的元素就是下一个时间最近，等着过期的信息了。这里涉及到了最小堆数据结构的操作就不多讲了。有兴趣的同学可以自己去看看实现。这就是我的项目实现的大概思路， 真正实现的话还要去考虑还没过期就被用户删除了等等的情况。</p> <p>到这里了我又在想，不行啊，这样过期了也只是“悄悄”的过期了。 我想知道它什么时候过期的，也就是我希望它过期的时候能通知我一声行不行啊？ 于是经过我又一轮的冥思苦想，我发现我去年学的发布-订阅模式可以用到这里。然后就是代码实现啦，无非就是做了一个observers对象。 以存储的key名去订阅了一个事件，在我的项目中就是<code>storage.on('name', (key)=&gt;{})</code> 然后再定时器执行的时候我会<code>observers.trriger('name')</code>去发布这个事件，并且将需要被删除掉的信息的key传入订阅的函数当中。 这样就做到了通知的功能。具体发布-订阅模式怎么实现的也不在此多做赘述了。</p> <h3 id="四、无耻的总结"><a href="#四、无耻的总结" aria-hidden="true" class="header-anchor">#</a> 四、无耻的总结</h3> <p><strong>sweet-storage</strong> 实现的大概思路就说完了，有兴趣的同学可以去看看源码实现，在此强调 github的地址为：<a href="https://github.com/Chechengyi/sweet-storage" target="_blank" rel="noopener noreferrer">https://github.com/Chechengyi/sweet-storage<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。   我的代码写的很通（垃）俗易（圾）懂。</p> <p>我还将这个项目传到了npm上面， <code>npm install sweet-storage</code>就可以安装到本地。学以致用，这一年多来在各大论坛潜水每次看到别人分享心得心里都痒痒的，这次总算是下定了决心踏出第一步。在这个过程中也学习到了很多，希望自己能够坚持下去。</p> <p>如果有不对的地方希望朋友们指出，希望朋友们多给我提建议</p> <p>最后在强调一波！！！</p> <p>github的地址为：<a href="https://github.com/Chechengyi/sweet-storage" target="_blank" rel="noopener noreferrer">https://github.com/Chechengyi/sweet-storage<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>求star 求fuck......</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.7b18d2f0.js" defer></script><script src="/assets/js/26.8399a71b.js" defer></script>
  </body>
</html>
