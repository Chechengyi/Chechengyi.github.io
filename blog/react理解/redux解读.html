<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>redux解读 | 车程一的博客</title>
    <meta name="description" content="车程一的博客">
    <link rel="icon" href="/vue-logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.2fbf6f8b.css" as="style"><link rel="preload" href="/assets/js/app.7b18d2f0.js" as="script"><link rel="preload" href="/assets/js/11.59d62fd9.js" as="script"><link rel="prefetch" href="/assets/js/10.ea08bc69.js"><link rel="prefetch" href="/assets/js/12.426af9d7.js"><link rel="prefetch" href="/assets/js/13.b2bd6144.js"><link rel="prefetch" href="/assets/js/14.1790ff5e.js"><link rel="prefetch" href="/assets/js/15.584f93ea.js"><link rel="prefetch" href="/assets/js/16.659d2a43.js"><link rel="prefetch" href="/assets/js/17.7825b058.js"><link rel="prefetch" href="/assets/js/18.0b08fef9.js"><link rel="prefetch" href="/assets/js/19.c553a9ae.js"><link rel="prefetch" href="/assets/js/2.ef1579f9.js"><link rel="prefetch" href="/assets/js/20.1a95086a.js"><link rel="prefetch" href="/assets/js/21.57c66887.js"><link rel="prefetch" href="/assets/js/22.3570ca0d.js"><link rel="prefetch" href="/assets/js/23.7fe8ebe9.js"><link rel="prefetch" href="/assets/js/24.5c706192.js"><link rel="prefetch" href="/assets/js/25.d8757158.js"><link rel="prefetch" href="/assets/js/26.8399a71b.js"><link rel="prefetch" href="/assets/js/27.4b3a213a.js"><link rel="prefetch" href="/assets/js/28.eb31cdf1.js"><link rel="prefetch" href="/assets/js/29.577144a6.js"><link rel="prefetch" href="/assets/js/3.62eea2c7.js"><link rel="prefetch" href="/assets/js/30.ef956d23.js"><link rel="prefetch" href="/assets/js/31.2e8ab40d.js"><link rel="prefetch" href="/assets/js/32.9d1685a0.js"><link rel="prefetch" href="/assets/js/33.d800be4d.js"><link rel="prefetch" href="/assets/js/34.85d350fe.js"><link rel="prefetch" href="/assets/js/35.1625e166.js"><link rel="prefetch" href="/assets/js/36.5cf7699d.js"><link rel="prefetch" href="/assets/js/37.0437fe8d.js"><link rel="prefetch" href="/assets/js/38.ca058290.js"><link rel="prefetch" href="/assets/js/39.d4f95e20.js"><link rel="prefetch" href="/assets/js/4.91c625b2.js"><link rel="prefetch" href="/assets/js/40.211acfac.js"><link rel="prefetch" href="/assets/js/41.a5df0168.js"><link rel="prefetch" href="/assets/js/42.6318b490.js"><link rel="prefetch" href="/assets/js/43.a6543bac.js"><link rel="prefetch" href="/assets/js/44.b04565e5.js"><link rel="prefetch" href="/assets/js/45.3bb1a5c1.js"><link rel="prefetch" href="/assets/js/46.15ed4362.js"><link rel="prefetch" href="/assets/js/47.e838dcd2.js"><link rel="prefetch" href="/assets/js/48.0a220d6c.js"><link rel="prefetch" href="/assets/js/49.a81b7774.js"><link rel="prefetch" href="/assets/js/5.a6bc510c.js"><link rel="prefetch" href="/assets/js/50.5ae2a1df.js"><link rel="prefetch" href="/assets/js/51.1e50c0a5.js"><link rel="prefetch" href="/assets/js/52.05832c5b.js"><link rel="prefetch" href="/assets/js/6.edf1ab01.js"><link rel="prefetch" href="/assets/js/7.75a4d63f.js"><link rel="prefetch" href="/assets/js/8.ac427bc7.js"><link rel="prefetch" href="/assets/js/9.7c5ccd0b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2fbf6f8b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">车程一的博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div> <a href="https://github.com/chechengyi" target="_blank" rel="noopener noreferrer" class="repo-link">
    我的github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div> <a href="https://github.com/chechengyi" target="_blank" rel="noopener noreferrer" class="repo-link">
    我的github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading open"><span>前端实战</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/blog/前端实战/跨域及其处理方式.html" class="sidebar-link">跨域及其处理方式</a></li><li><a href="/blog/前端实战/移动端适配问题.html" class="sidebar-link">移动端适配问题</a></li><li><a href="/blog/前端实战/给localStorage加上过期时间.html" class="sidebar-link">给localStorage加上过期时间</a></li><li><a href="/blog/前端实战/react实现一个分页、搜索高阶组件.html" class="sidebar-link">react实现一个分页、搜索高阶组件</a></li><li><a href="/blog/前端实战/nginx设置资源缓存实战.html" class="sidebar-link">nginx设置资源缓存实战</a></li><li><a href="/blog/前端实战/前后端分离下前端权限处理.html" class="sidebar-link">前后端分离下前端权限处理</a></li><li><a href="/blog/前端实战/从react hooks“闭包陷阱”切入，浅谈react hooks.html" class="sidebar-link">从react hooks“闭包陷阱”切入，浅谈react hooks</a></li><li><a href="/blog/前端实战/BFC及其理解.html" class="sidebar-link">BFC及其理解</a></li><li><a href="/blog/前端实战/react优化-精确更新视窗内组件.html" class="sidebar-link">react优化-精确更新视窗内组件</a></li><li><a href="/blog/前端实战/typescript内置类型学习.html" class="sidebar-link">typescript内置类型学习</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>js相关</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>react理解</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>总结记录</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>数据结构算法</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="redux解读"><a href="#redux解读" aria-hidden="true" class="header-anchor">#</a> redux解读</h1> <h2 id="redux-整体流程"><a href="#redux-整体流程" aria-hidden="true" class="header-anchor">#</a> redux 整体流程</h2> <p>首先看，<code>redux</code> 一般来说在使用到我们的项目中的时候怎么去初始定义的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducers<span class="token punctuation">,</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>ceshi<span class="token punctuation">,</span> thunk<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>可以看到，其实就是调用了一个 <code>createStore</code> 方法，顾命思义也可以明白这个方法就是用来初始化 store 的。以下为 <code>createStore</code> 的简单实现。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> enhancer<span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>enhancer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">enhancer</span><span class="token punctuation">(</span>createStore<span class="token punctuation">)</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> currentState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">var</span> currentListeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">function</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> currentState
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">subscribe</span> <span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">{</span>
        currentListeners<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">dispatch</span> <span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">{</span>
        currentState <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>currentState<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
        currentListeners<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span> f<span class="token operator">=&gt;</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
        <span class="token comment">// return action</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 在初始化的时候传入一个特殊的 action， 所有都匹配不上，就返回了初始的状态树</span>
    <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token punctuation">:</span> <span class="token string">'@CCY-REDUX'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> getState<span class="token punctuation">,</span> subscribe<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>reducer</code> 其实是一个纯函数（一个函数的返回结果只依赖于它的参数，并且在执行过程里面没有副作用）。一般来说 <code>reducer</code> 长什么样子呢？</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">ADD_AGE</span> <span class="token operator">=</span> <span class="token string">'ADD_AGE'</span>
<span class="token keyword">const</span> <span class="token constant">REMOVE_AGE</span> <span class="token operator">=</span> <span class="token string">'REMOVE_AGE'</span>

<span class="token keyword">const</span> initalState <span class="token operator">=</span> <span class="token punctuation">{</span>
	name<span class="token punctuation">:</span> <span class="token string">'Chechengyi'</span><span class="token punctuation">,</span>
	age<span class="token punctuation">:</span> <span class="token number">22</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> handlers <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">[</span><span class="token constant">ADD_AGE</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token punctuation">{</span>
			age<span class="token punctuation">:</span> state<span class="token punctuation">.</span>age <span class="token operator">+</span> <span class="token number">1</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">[</span><span class="token constant">REMOVE_AGE</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token punctuation">{</span>
			age<span class="token punctuation">:</span> state<span class="token punctuation">.</span>age <span class="token operator">-</span><span class="token number">1</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// reducer</span>

<span class="token keyword">function</span> <span class="token function">createReducer</span> <span class="token punctuation">(</span>initState<span class="token punctuation">,</span> handlers<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> state<span class="token operator">=</span>initState<span class="token punctuation">,</span> action <span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> handler <span class="token operator">=</span> handlers<span class="token punctuation">[</span>action<span class="token punctuation">.</span>type<span class="token punctuation">]</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handler<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token operator">...</span>state<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token operator">...</span>state<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token function">handler</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token function">createReducer</span><span class="token punctuation">(</span>initalState<span class="token punctuation">,</span> handlers<span class="token punctuation">)</span>
</code></pre></div><p>这是我比较习惯使用的 <code>reducer</code> 的定义方法，其实 <code>reducer</code> 就是根据 <code>action</code> 提供的type，固定的返回当前的 type 所对应的 <code>state</code>。</p> <p>一般在使用的 redux 提供了一个方法来帮助我们组合 <code>reducer</code>，这个方法就是 <code>combineReducers</code>。可以认为下面的代码是 <code>combineReducers</code> 的简化实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span>reducers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> finalReducers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>reducers<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        finalReducers<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">=</span> reducers<span class="token punctuation">[</span>item<span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token punctuation">)</span>
    <span class="token keyword">let</span> finalReducersKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>finalReducers<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">combination</span><span class="token punctuation">(</span> state<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> action <span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> hasChange <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">let</span> nextState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>finalReducersKeys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> key <span class="token operator">=</span> finalReducersKeys<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token keyword">const</span> reducer <span class="token operator">=</span> finalReducers<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
            <span class="token keyword">const</span> prevStateForKey <span class="token operator">=</span> state<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
            <span class="token keyword">const</span> nextStateForKey <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>prevStateForKey<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
            nextState<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> nextStateForKey
            hasChange <span class="token operator">=</span> hasChange <span class="token operator">||</span> prevStateForKey <span class="token operator">!==</span> nextStateForKey
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> hasChange<span class="token operator">?</span> nextState <span class="token punctuation">:</span> state
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其实看到这里，当我们忽略 <code>enhancer</code> 不去看的时候，<code>redux</code> 看起来就真的很简单。<code>createStore</code> 初始化了 <code>store</code>，<code>redux</code> 不能直接的去获取 <code>state</code> ，需要根据 <code>getState</code> 方法来获取 <code>state</code>，也不能直接的去操作 <code>state</code> ，需要根据 <code>dispatch</code> 方法去触发一个 <code>action</code> 来更改状态，<code>redux</code> 还提供了订阅的方法，每当有 <code>dispatc</code> 操作的时候就触发订阅的方法。</p> <h2 id="_2-中间件"><a href="#_2-中间件" aria-hidden="true" class="header-anchor">#</a> 2 中间件</h2> <p>仿佛世间的事情都遵循这样的规律，简单的东西虽然小而美，但是往往不能覆盖很多的场景。刚刚所说的 <code>dispatch</code> 所接收的 <code>action</code> 只能是一个对象，这大大的限制了我们在发起一个 <code>dispatch</code> 时候的能力，针对这种情况，redux 采用了中间件的方式来解决，这样扩展性极强，我们可以根据自己的实际需要编写相应的中间件。而引入中间件的部分就在：<code>applyMiddleware(ceshi, thunk)</code> ，其中的 <code>ceshi</code>、<code>thunk</code> 就是我们的中间件。</p> <p>首先看: <code>applyMiddleware</code> 这个方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token operator">...</span>middlewares<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> createStore <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
        <span class="token keyword">let</span> dispatch <span class="token operator">=</span> store<span class="token punctuation">.</span>dispatch

        <span class="token keyword">const</span> midApi <span class="token operator">=</span> <span class="token punctuation">{</span>
            getState<span class="token punctuation">:</span> store<span class="token punctuation">.</span>getState<span class="token punctuation">,</span>
            <span class="token comment">// dispatch: (...args)=&gt;dispatch(...args)</span>
            dispatch<span class="token punctuation">:</span> store<span class="token punctuation">.</span>dispatch
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> middlewareChain <span class="token operator">=</span> middlewares<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> middleware<span class="token operator">=&gt;</span><span class="token function">middleware</span><span class="token punctuation">(</span>midApi<span class="token punctuation">)</span> <span class="token punctuation">)</span>
        <span class="token comment">// middlewareChain是一个其中每一项都为函数的数组，依照中间件的编码方式，这里存的</span>
        <span class="token comment">// 函数的格式为： (midApi已经作为中间件函数的第一层{dispatch, getState}传递了进去)</span>
        <span class="token comment">// next=&gt;action=&gt;</span>
        <span class="token comment">// dispatch = middleware(midApi)(store.dispatch)</span>
        dispatch <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token operator">...</span>middlewareChain<span class="token punctuation">)</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>dispatch<span class="token punctuation">)</span>
        <span class="token comment">// compose(...middleware) 返回的是 (...args)=&gt;ret(item(...args))</span>
        <span class="token comment">// store.dispatch作为参数传递了进去 即...args为store.dispatch</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token operator">...</span>store<span class="token punctuation">,</span>
            dispatch
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到，先是给每个中间件传入了 <code>redux</code> 的 <code>getState</code> 和 <code>dispatch</code> 的方法（这些方法被中间件以闭包的形式保存了）。然后调用了一个相当关键的方法：<code>compose</code> 用于生成新的 <code>dispatch</code> 的方法（这个 <code>dispatch</code> 方法最后顶替了 <code>createStore</code> 提供的 <code>dispatch</code> 方法）。</p> <p>那么最关键的地方就在于，<code>compose</code> 方法到底做了什么？</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token operator">...</span>funcs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>funcs<span class="token punctuation">.</span>length<span class="token operator">===</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> arg <span class="token operator">=&gt;</span> arg
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>funcs<span class="token punctuation">.</span>length<span class="token operator">===</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> funcs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> funcs<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>ret<span class="token punctuation">,</span>item<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">ret</span><span class="token punctuation">(</span><span class="token function">item</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这段代码真的好短，但是也真的有点绕人。</p> <p>首先可以确定的是，<code>compose</code> 方法最终返回的还是一个函数。</p> <p><code>compose(fn1, fn2, fn3) (...args) = &gt; fn1(fn2(fn3(...args)))</code></p> <p>最终，经过 <code>compose</code> 方法包装后的中间件和 <code>dispatch</code> 所生成的新的 <code>dispatch</code> 方法所接受的参数，会被作为参数传递到最后一个中间件里。</p> <p>首先来一看一个啥都不做的中间件是如何实现的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">doNothingMidddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span>dispatch<span class="token punctuation">,</span> getState<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> next <span class="token operator">=&gt;</span> action <span class="token operator">=&gt;</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
</code></pre></div><p>然后接下来是模仿 <code>redux-thunk</code> 中间件的实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">thunk</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>dispatch<span class="token punctuation">,</span> getState<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>next<span class="token operator">=&gt;</span>action<span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log('..thunk', typeof action)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">action</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">,</span> getState<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样有点类似 <code>koa</code> 所说的 “洋葱圈模型”。</p> <p>action 对象，会被我们所注册的中间件依次处理，只有排在前面的中间件完成任务之后，后面的中间件才有机会继续处理 action，同样的，每个中间件都有自己的“熔断”处理,当它认为这个 action 不需要后面的中间件进行处理时，后面的中间件也就不能再对这个 action 进行处理了。</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.7b18d2f0.js" defer></script><script src="/assets/js/11.59d62fd9.js" defer></script>
  </body>
</html>
